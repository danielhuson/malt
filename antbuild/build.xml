<!-- file build.xml in your project root directory -->
<!-- Ant build script for yfiles -->
<!-- The java based Ant tool is available from -->
<!-- http://jakarta.apache.org/ant -->
<!-- This file demonstrates the use of the yGuard byte -->
<!-- code obfuscator from yWorks Gmbh -->
<!-- yGuard can be downloaded from -->
<!--- http://www.yworks.com/products/yguard -->

<project name="project" default="sign" basedir=".">

    <!-- edit the following lines to your needs -->
    <property name="project_name" value="MALT"/>
    <property name="jlodaSrcDir" value="../../jloda/src"/>
    <property name="meganSrcDir" value="../../megan6/src"/>
    <property name="maltSrcDir" value="../../malt/src"/>
    <property name="srcDir" value="src"/>
    <property name="classDir" value="classes"/>
    <property name="jar" value="${project_name}_raw.jar"/>
    <property name="obfjar" value="${project_name}.jar"/>
    <property name="renamelog" value="${project_name}_renamelog.xml"/>
    <property name="shrinklog" value="${project_name}_shrinklog.xml"/>
    <property name="mainclass" value="malt.MaltBuild"/>
    <property name="mainclass2" value="malt.MaltRun"/>

    <!-- class path -->

    <path id="build.classpath"> 
	    <fileset dir="../../jloda/jars"  includes="*.jar"/>
	    <fileset dir="../../jloda/jars/batik-1.8"  includes="*.jar"/>

	   <fileset dir="../../megan6/jars/megan5server"  includes="*.jar"/>
	<fileset dir="../../megan6/jars"  includes="*.jar"/>
	    <fileset dir="../jars"  includes="*.jar"/>
	    
   </path>

    <!-- init -->
    <target name="init">
        <mkdir dir="${srcDir}"/>
        <mkdir dir="${classDir}"/>
        <mkdir dir="${classDir}/resources"/>
    </target>

    <!-- copy resources -->
    <target name="copy_resources" depends="init">
	    <mkdir dir="${classDir}/resources"/>
	    <mkdir dir="${classDir}/resources/css"/>
	    <mkdir dir="${classDir}/resources/files"/>
	    <copy todir="${classDir}">
		    <fileset dir="../resources" includes="log4j.properties"/>
        </copy>
    </target>

    <!-- copy sources -->
    <target name="copy_sources" depends="copy_resources">
        <copy todir="${srcDir}">
            <fileset dir="${jlodaSrcDir}" excludes=".svn/**"/>
	    <fileset dir="${meganSrcDir}" excludes=".svn/**"/>
	    <fileset dir="${maltSrcDir}" excludes=".svn/**"/>
        </copy>
    </target>

    <!-- compile  MALT -->
    <target name="compile" depends="copy_sources">
	    <javac  includeantruntime="false"
		    srcdir="${srcDir}"
               destdir="${classDir}"
	       debug="on"
               compiler="javac1.7"
	       source="1.7"
	       target="1.7"
	       classpathref="build.classpath">
	       <compilerarg value="-XDignore.symbol.file=true"/> 
        </javac>
    </target>

    <!-- create .jar -->
    <target name="jar" depends="compile">
        <jar jarfile="${jar}"
             basedir="${classDir}"
	     includes="jloda/** megan/** megan6u/** malt/** rusch/**">
        </jar>
    </target>

    <!-- obfuscate .jar -->

    <target name="yguard" depends="jar">
        <taskdef name="yguard" classname="com.yworks.yguard.YGuardTask"
		classpath="../../../java/jars/yguard-2.5.1/lib/yguard.jar"
                 classpathref="build.classpath"
                />
        <!-- the following can be adjusted to your needs -->
        <yguard>

            <inoutpair in="${jar}" out="${obfjar}"/>

            <shrink logfile="${shrinklog}">

                <keep>
                    <class classes="protected"
                           methods="protected" fields="protected">
                        <patternset>
				<include name="jloda.*"/>
				<include name="jloda.**.*"/>
				<include name="**.commands.*"/>
				<include name="**.commands.**.*"/>
				<include name="rusch.**.*"/>
				<include name="rusch.*"/>

				<include name="megan.biom.**.*"/>
				<include name="megan.access.**.*"/>
                        	<include name="megan.core.ClassificationType"/>

				<include name="megan.tools.Blast2LCA"/>
				<include name="megan.tools.BLAST2RMA6"/>
				<include name="megan.tools.SAM2RMA6"/>
                            <include name="megan.tools.DAA2RMA6"/>
                            <include name="megan6u.tools.DAAMeganizer"/>
                            <include name="megan6u.tools.kegg.MakeKeggTree"/>
                            <include name="megan6u.tools.kegg.MakeGiToKeggMap"/>
                            <include name="megan6u.tools.utils.ExtendMappingsUsingReferenceFastA"/>

				<include name="megan.chart.drawers.*"/>
				<include name="megan6u.chart.drawers.*"/>


                       	<include name="megan.daa.io.*"/>
			<include name="megan.daa.io.**.*"/>
			
			<include name="malt.MaltBuild"/>
			<include name="malt.MaltRun"/>

                     </patternset>
	     </class>
	     <method class="${mainclass}" name="void main(java.lang.String[])"/>
	     <method class="${mainclass2}" name="void main(java.lang.String[])"/>
                </keep>
            </shrink>

            <rename mainclass="${mainclass}" logfile="${renamelog}">
                <property name="error-checking" value="pedantic"/>

                <keep>
                    <class classes="protected"
                           methods="protected" fields="protected">
			   <patternset>
				   <include name="jloda.*"/>
				   <include name="jloda.**.*"/>
				   <include name="**.commands.*"/>
				   <include name="**.commands.**.*"/>
				   <include name="rusch.**.*"/>
				   <include name="rusch.*"/>
				   
				   <include name="megan.biom.**.*"/>
				   <include name="megan.access.**.*"/>
				   <include name="megan.core.ClassificationType"/>

				   <include name="megan.tools.Blast2LCA"/>
				   <include name="megan.tools.BLAST2RMA6"/>
				   <include name="megan.tools.SAM2RMA6"/>
                   		<include name="megan.tools.DAA2RMA6"/>
                            	<include name="megan6u.tools.DAAMeganizer"/>
                            <include name="megan6u.tools.kegg.MakeKeggTree"/>
                            <include name="megan6u.tools.kegg.MakeGiToKeggMap"/>
                            <include name="megan6u.tools.utils.ExtendMappingsUsingReferenceFastA"/>

				<include name="megan.chart.drawers.*"/>
				<include name="megan6u.chart.drawers.*"/>

                       	<include name="megan.daa.io.*"/>
			<include name="megan.daa.io.**.*"/>

			<include name="malt.MaltBuild"/>
			<include name="malt.MaltRun"/>
                      </patternset>
                    </class>
		    <method class="${mainclass}" name="void main(java.lang.String[])"/>
	     		<method class="${mainclass2}" name="void main(java.lang.String[])"/>
                </keep>
            </rename>

        </yguard>

    </target>


    <target name="sign" depends="yguard">
       <signjar jar="${obfjar}"
                 alias="DanielHusonsLab"
                 storepass="p1r0ng1A"
                 keypass="p1r0ng1A"
                 keystore="/Users/huson/etc/keystore2"
                 verbose="false"/>
    </target>

    <!-- run project -->
    <target name="run" depends="yguard">
        <java classname="${mainclass}" fork="true"
              classpathref="build.classpath">
            <classpath>
                <pathelement location="${obfjar}"/>
            </classpath>
	    <arg value="-h"/>
            <jvmarg value="-Dapple.laf.useScreenMenuBar=true"/>
            <jvmarg value="-server"/>
            <jvmarg value="-d64"/>
            <jvmarg value="-Xmx2000M"/>
            <jvmarg value="-Duser.language=en"/>
            <jvmarg value="-Duser.region=US"/>
        </java>
</target>

    <!-- run project -->
    <target name="run2" depends="yguard">
        <java classname="${mainclass2}" fork="true"
              classpathref="build.classpath">
            <classpath>
                <pathelement location="${obfjar}"/>
            </classpath>
	    <arg value="-h"/>
            <jvmarg value="-Dapple.laf.useScreenMenuBar=true"/>
            <jvmarg value="-server"/>
            <jvmarg value="-d64"/>
            <jvmarg value="-Xmx2000M"/>
            <jvmarg value="-Duser.language=en"/>
            <jvmarg value="-Duser.region=US"/>
        </java>
    </target>


    <!-- removes all that has been built -->
    <target name="clean">
	    <delete dir="${classDir}" includeEmptyDirs="true"/>
	    	<delete dir="${srcDir}" includeEmptyDirs="true"/>
		<delete file="${jar}"/>
		<delete file="${obfjar}"/>
		<delete file="${shrinklog}"/>
		<delete file="${renamelog}"/>
        <delete file="yfiles.jar"/>
    </target>
</project>

        <!-- end file build.xml -->
